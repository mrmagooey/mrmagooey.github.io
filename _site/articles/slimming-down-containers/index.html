

  <meta charset="utf-8">
<title>Reducing Container Size &#8211; mrmagooey.github.io</title>
<meta name="description" content="A few tips">
<meta name="keywords" content="docker, containers">


<meta property="og:locale" content="en_US">
<meta property="og:title" content="Reducing Container Size &#8211; mrmagooey.github.io">
<meta property="og:description" content="A few tips">
<meta property="og:url" content="/articles/slimming-down-containers">
<meta property="og:site_name" content="mrmagooey.github.io">


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="mrmagooey.github.io Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Type -->
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Crimson+Text:400,400italic,700,700italic" rel='stylesheet' type='text/css' />
<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/assets/css/entypo.css" media="all">

<!-- In order to use Calendas Plus, you must first purchase it. Then, create a font-face package using FontSquirrel.
<link rel='stylesheet' href='/assets/cal.css' media='all' />
-->



<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/i.css">

<!-- Fresh Squeezed jQuery -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">

<div id="bump">
  <body class="">
    <header class="site-header darken">
      <div class="wrap">
        <hgroup>
          <h1><a href="/">mrmagooey.github.io</a></h1>
        </hgroup>
        <a href="#nav" class="menu"><span class='icons'>☰</span></a>
        <nav role="navigation">
          <ul>
            <li>
              <a href="/" title="mrmagooey.github.io">Home</a>
            </li>
            
            
                <li><a href="https://github.com/mrmagooey/" target="_blank">Github</a></li>
            

          </ul>
        </nav>
      </div>
    </header>


  <section class="article pad-top">

    


    <article class="wrap post">
      <header class="post-header">
        <hgroup>
          <h1>Reducing Container Size</h1>
          <p class="date">Jul 20, 2017</p>
          <p class="intro">A few tips</p>
        </hgroup>
      </header>

      <p>Size of container images is a temptingly easy metric to measure, but it also has significant ramifications for both the developer of the container and the end-users of it. A smaller container will be downloaded faster, and consume less resources on the host both whilst running as a container and whilst being stored as an image. For example, if your container is run on 1000 different hosts, every megabyte you shave off the container image is 1GB that didn’t need to be sent over a network, or stored somewhere.</p>

<p>The following are some tips for reducing the size of containers.</p>

<h3 id="usrshare">/usr/share</h3>

<p>If you use ubuntu as the base for your containers, every container you have built has also included:</p>

<ul>
  <li><em>/usr/share/man</em> man pages you will never read. 5.8MB</li>
  <li><em>/usr/share/docs</em> docs you you will never read. 3.6MB</li>
  <li><em>/usr/locale/</em> locales that you will probably never need. 8.9MB</li>
</ul>

<p>Totalling 18.3MB of information that your container can probably do without. Given that the whole image is 119MB (ubuntu:16.04), removing these three directories is ~15% space saving on that image, without losing much of value. The locale removal is probably the diciest change, but I haven’t had any issues so far.</p>

<p>To have these changes made to your container, add the following somewhere (e.g. a RUN command or shell script):</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># disable apt installing locales other than en</span>
<span class="nb">echo</span> <span class="s2">&quot;path-exclude=/usr/share/locale/*&quot;</span> &gt;&gt; /etc/dpkg/dpkg.cfg.d/01_nodoc
<span class="nb">echo</span> <span class="s2">&quot;path-include=/usr/share/locale/en&quot;</span> &gt;&gt; /etc/dpkg/dpkg.cfg.d/01_nodoc

<span class="c"># overwrite the supported locales with just us english</span>
mkdir -p /var/lib/locales/supported.d/
<span class="nb">echo</span> <span class="s2">&quot;en_US.UTF-8 UTF-8&quot;</span> &gt; /var/lib/locales/supported.d/en

<span class="c"># Drop all manuals</span>
<span class="nb">echo</span> <span class="s2">&quot;path-exclude=/usr/share/man/*&quot;</span> &gt;&gt; /etc/dpkg/dpkg.cfg.d/01_nodoc

<span class="c"># Drop all docs, except copyright</span>
<span class="nb">echo</span> <span class="s2">&quot;path-exclude=/usr/share/doc/*&quot;</span> &gt;&gt; /etc/dpkg/dpkg.cfg.d/01_nodoc
<span class="nb">echo</span> <span class="s2">&quot;path-include=/usr/share/doc/*/copyright&quot;</span> &gt;&gt; /etc/dpkg/dpkg.cfg.d/01_nodoc
<span class="nb">echo</span> <span class="s2">&quot;path-exclude=/usr/share/lintian/*&quot;</span> &gt;&gt; /etc/dpkg/dpkg.cfg.d/01_nodoc
<span class="nb">echo</span> <span class="s2">&quot;path-exclude=/usr/share/linda/*&quot;</span> &gt;&gt; /etc/dpkg/dpkg.cfg.d/01_nodoc

<span class="c"># delete everything, apt will re-install based on the dpkg rules we have above</span>
rm -rf /usr/share/doc
rm -rf /usr/share/man
rm -rf /usr/share/locale</code></pre></div>

<p>You will see apt packages complaining about not having things in /usr/share but they seem to install just fine.</p>

<p>A bunch of these are taken from <a href="https://wiki.ubuntu.com/ReducingDiskFootprint">the ubuntu wiki</a>.</p>

<h3 id="apt-get">Apt-get</h3>

<p>Many packages have “recommended” dependencies, without which they work fine, but don’t have as much functionality. Telling apt not to install these recommended dependencies ensures that your container isn’t filled with well meaning but purposeless packages.</p>

<p>So instead of just doing:</p>

<pre><code>apt-get install -y &lt;packages&gt;
</code></pre>

<p>Change your command to be:</p>

<pre><code>apt-get install -y --no-install-recommmends &lt;packages&gt;
</code></pre>

<p>You can also safely save some space by removing the package list information from your container when you are finished installing packages (and any temp files).</p>

<pre><code>apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
</code></pre>

<p>This will delete all the information retrieved by <code>apt-get update</code>.</p>

<h3 id="diy-base-container">DIY Base Container</h3>

<p>Building your own container base from scratch is now much easier than what it once, and so you can make do without using something like https://github.com/phusion/baseimage-docker (from which I’m taking a bunch of these tikps), which will generally mean a smaller image.</p>

<h4 id="init-process">Init Process</h4>

<p>Docker now has an init system <a href="https://github.com/krallin/tini">tini</a> that it will inject into your container if you ask it nicely (add the <code>--init</code> flag to <code>docker run</code>), taking care of the Zombie Process Problem™. You can also build your container with this init process baked in , so that your end user can never forget to run init. This will ensure correct handling of signals and reaping zombies, whilst only weighing in at 20kB. However, tini is not responsible for starting/restarting processes for which you need a service supervision.</p>

<h4 id="service-supervision">Service supervision</h4>

<p>If you want to run multiple processes in your container, you generally will want something to ensure that these processes start, and are restarted if they die, i.e. service supervision.</p>

<p>Part of the <code>runit</code> system is <code>runsvdir</code> daemon, which when pointed at a directory containing run scripts, will watch and run these scripts, restarting them if they die. Using <code>runsvdir</code> is the approach that <code>baseimage-docker</code> takes.</p>

<p>However, if your container is only expected to ever have a single running process, then a service supervision system is totally unnecessary.</p>

<h3 id="misc-tips">Misc tips</h3>

<ol>
  <li>Don’t build your application in the same container that will eventually run it. Build separately, then copy the binary to the container. For compiled applications, this will ensure that your final container doesn’t have build artifacts, compilers, libraries that it doesn’t necessarily need.</li>
  <li>If you can avoid using languages that require an interpreter/vm/runtime to execute then you can save a bunch of space in your container. Just installing python generally adds 30MB to a system, and that is before any user code and dependencies are added.</li>
  <li>If you have a compiled application that you bundle with a container image, run [Ultimate Packer for eXecutables (UPX)] (https://github.com/upx/upx) across the binary to compress it before adding it to the image.</li>
</ol>


      
      
      
      

    </article>
  </section>
</div>


<div class="push"></div>
<footer>
  <aside class="wrap">
    <ol class="prev-posts">
      <p class="list-title">Recent Posts</p>
       <!-- for1 -->
      <li>
        <span class="recent-title"><a href="/articles/speeding-up-container-builds" title="Speeding up Container Builds">Speeding up Container Builds </a></span>
        <span class="date">Jul 21, 2017</span>
      </li>
       <!-- for1 -->
      <li>
        <span class="recent-title"><a href="/articles/slimming-down-containers" title="Reducing Container Size">Reducing Container Size </a></span>
        <span class="date">Jul 20, 2017</span>
      </li>
       <!-- for1 -->
      <li>
        <span class="recent-title"><a href="/articles/2016-01-13-libspotify" title="Using libspotify">Using libspotify </a></span>
        <span class="date">Jan 12, 2016</span>
      </li>
      
    </ol>

    <div class="social">
      <ul>
        
        
        


        
      </ul>
    </div>
  </aside>
  <small>&copy; 2017 mrmagooey. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://jekyll.gtat.me/about">Balzac</a> theme.</small>
</footer>

<!-- If they're out, get some from the cellar -->
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
  <script src="/assets/js/retina.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-28090801-2', 'auto');
  ga('send', 'pageview');

</script>
  <!-- Custom JS -->
  <script src="/assets/js/scripts.js"></script>


</body>
</html>

